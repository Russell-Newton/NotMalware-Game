package whatexe.dungeoncrawler;

import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.SceneAntialiasing;

import java.io.IOException;
import java.net.URL;
import java.util.HashMap;
import java.util.Map;

/**
 * The SceneManager allows for managing a lot of FXML Scenes by using methods that can change the
 * state of Scenes. It can also be used to save and load states. Ideally, a scene should be
 * unloaded when not needed, so that it doesn't hang in memory, but it can be loaded back up when
 * needed.
 * <br><br>
 * Scenes managed by a SceneManager are saved as FXML files, with controllers that extend
 * {@link ManagedController}.
 * <br><br>
 * The SceneManager is modeled as a Singleton. Only one instance ever exists. Access its methods
 * with the provided {@link SceneManager#getInstance()} method.
 */
public class SceneManager {

    private static SceneManager instance;

    /**
     * This map contains the {@link FXMLLoader}s that represent each scene added to the
     * SceneManager.
     * FXMLLoader instances are initialized with {@link URL} locations, such as those generated by
     * <PRE>
     * getClass().getResource(filepath);
     * </PRE>
     * The scenes and {@link ManagedController}s defined by these FXMLLoaders are only loaded
     * when {@link SceneManager#loadScene(String)} is called. The loaders are subsequently
     * replaced by unloaded FXMLLoaders that haven't loaded the scenes and controllers from the
     * FXML yet when {@link SceneManager#unloadScene(String)} is called.
     */
    private final Map<String, FXMLLoader> loaderMap;

    /**
     * This map contains the {@link Scene}s that are currently loaded by the SceneManager. This
     * map will get modified when any of the following methods are called:
     * {@link SceneManager#loadScene(String)}, {@link SceneManager#loadScene(String, Map)}, or
     * {@link SceneManager#unloadScene(String)}.
     * <br><br><strong>
     * Note: Scenes are created in accordance to the {@link SceneManager#parentMap}. Parents can
     * only be used in one Scene, and not all of these Scenes are saved in this map.
     * </strong>
     */
    private final Map<String, Scene> sceneMap;

    /**
     * This map contains the {@link Parent}s that are currently loaded by the SceneManager. This
     * map will get modified when any of the following methods are called:
     * {@link SceneManager#loadParent(String)}, {@link SceneManager#loadScene(String, Map)},
     * {@link SceneManager#loadScene(String)}, {@link SceneManager#loadScene(String, Map)}, or
     * {@link SceneManager#unloadScene(String)}.
     * <br><br><strong>
     * Note: Parents can only be used in one Scene. Not all parents created here are used in the
     * {@link SceneManager#sceneMap}.
     * </strong>
     *
     * @see SceneManager#sceneMap
     */
    private final Map<String, Parent> parentMap;

    private SceneManager() {
        loaderMap = new HashMap<>();
        sceneMap = new HashMap<>();
        parentMap = new HashMap<>();
    }

    /**
     * @return the only instance of the SceneManager for this JVM.
     */
    public static SceneManager getInstance() {
        if (instance == null) {
            instance = new SceneManager();
        }
        return instance;
    }

    /**
     * Adds a scene to the {@link SceneManager#loaderMap}.
     *
     * @param sceneName the name of the scene, used for future referral.
     * @param location  the {@link URL} location of the FXML file. Can be generated by
     *                  <PRE>
     *                  getClass().getResource(filepath);
     *                  </PRE>
     */
    public void addScene(String sceneName, URL location) {
        if (loaderMap.containsKey(sceneName)) {
            throw new RuntimeException("Scene " + sceneName + " already added!");
        }
        FXMLLoader loader = new FXMLLoader(location);
        loaderMap.put(sceneName, loader);
    }

    /**
     * Removes an unloaded scene from the {@link SceneManager#loaderMap}. Scenes should be unloaded
     * before being removed from the loaderMap.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     */
    public void removeScene(String sceneName) {
        FXMLLoader loader = loaderMap.remove(sceneName);
        if (loader == null) {
            throw new RuntimeException("Cannot remove a scene that hasn't been added!");
        }
    }

    /**
     * Removes every scene from the SceneManager.
     */
    public void clear() {

        for (String loadedScene : sceneMap.keySet()) {
            unloadScene(loadedScene);
        }

        loaderMap.clear();
        sceneMap.clear();
        parentMap.clear();
    }

    /**
     * Gets a loaded scene from the {@link SceneManager#loaderMap}. Scenes have to be loaded by
     * {@link SceneManager#loadScene(String)} for this method to work.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     * @return the {@link Scene}.
     */
    public Scene getScene(String sceneName) {
        Scene scene = sceneMap.get(sceneName);
        Parent parent = parentMap.get(sceneName);
        if (parent == null) {
            throw new RuntimeException("Cannot get an uninitialized scene!");
        }
        if (scene == null) {
            throw new RuntimeException("Scene was loaded with loadParent() and not loadScene()!");
        }

        return scene;
    }

    /**
     * Gets a loaded scene from the {@link SceneManager#loaderMap}. Scenes have to be loaded by
     * {@link SceneManager#loadScene(String)} for this method to work.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     * @return the {@link Scene}.
     */
    public Parent getParent(String sceneName) {
        Parent parent = parentMap.get(sceneName);
        if (parent == null) {
            throw new RuntimeException("Cannot get an uninitialized parent!");
        }

        return parent;
    }

    /**
     * Gets the loaded {@link ManagedController} defined by the specified {@link FXMLLoader} mapped
     * from sceneName in the {@link SceneManager#loaderMap}.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     * @return the {@link ManagedController}.
     */
    public ManagedController getSceneController(String sceneName) {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() == null) {
            throw new RuntimeException("Cannot get the controller of an uninitialized scene!");
        }

        return loader.getController();
    }

    /**
     * Calls on {@link SceneManager#loadParent(String)} to add a {@link Parent} to the
     * {@link SceneManager#parentMap}. The Parent is then used to create a {@link Scene} that
     * gets saved into the {@link SceneManager#sceneMap}.
     *
     * @param sceneName the name of the scene, as entered in
     *                  {@link SceneManager#addScene(String, URL)}.
     * @return the loaded {@link Scene}, for method chaining.
     *
     * @throws IOException if the FXML file specified by the {@link URL} passed into
     *                     {@link SceneManager#addScene(String, URL)} cannot be opened.
     * @see SceneManager#loadScene(String, Map)
     */
    public Scene loadScene(String sceneName) throws IOException {
        return loadScene(sceneName, Map.of());
    }

    /**
     * Calls on {@link SceneManager#loadParent(String, Map)} to add a {@link Parent} to the
     * {@link SceneManager#parentMap}. The Parent is then used to create a {@link Scene} that
     * gets saved into the {@link SceneManager#sceneMap}.
     *
     * @param sceneName      the name of the scene, as entered in
     *                       {@link SceneManager#addScene(String, URL)}.
     * @param loadParameters optional parameters that are sent into the ManagedController's
     *                       {@link ManagedController#init(Map)} method.
     * @return the loaded {@link Scene}, for method chaining.
     *
     * @throws IOException if the FXML file specified by the {@link URL} passed into
     *                     {@link SceneManager#addScene(String, URL)} cannot be opened.
     * @see SceneManager#loadScene(String)
     */
    public Scene loadScene(String sceneName, Map<String, Object> loadParameters)
            throws IOException {
        Parent root = loadParent(sceneName, loadParameters);

        Scene scene = new Scene(root, -1, -1,
                                false, SceneAntialiasing.DISABLED);
        sceneMap.put(sceneName, scene);

        return scene;
    }

    /**
     * Loads a {@link Parent} in the {@link SceneManager#parentMap}. Initializes the
     * corresponding {@link ManagedController}.
     *
     * @param sceneName      the name of the scene, as entered in
     *                       {@link SceneManager#addScene(String, URL)}.
     * @param loadParameters optional parameters that are sent into the ManagedController's
     *                       {@link ManagedController#init(Map)} method.
     * @return the loaded {@link Parent}, for method chaining.
     *
     * @throws IOException if the FXML file specified by the {@link URL} passed into
     *                     {@link SceneManager#addScene(String, URL)} cannot be opened.
     * @see SceneManager#loadParent(String, Map)
     * @see SceneManager#loadScene(String)
     * @see SceneManager#loadScene(String, Map)
     */
    public Parent loadParent(String sceneName, Map<String, Object> loadParameters)
            throws IOException {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() != null) {
            throw new RuntimeException("Cannot initialize an already initialized scene!");
        }

        // Attempt to load the root node and controller
        Parent root = loader.load();
        parentMap.put(sceneName, root);
        ManagedController controller = loader.getController();

        if (controller == null) {
            throw new RuntimeException(
                    "Scene FXML must specify a controller that extends ManagedController!");
        }

        if (!(controller instanceof ManagedController)) {
            throw new RuntimeException("Scene's controller must extend ManagedController!");
        }

        // Initialize the controller
        controller.init(loadParameters);

        return root;
    }

    /**
     * Loads a {@link Parent} in the {@link SceneManager#parentMap}. Initializes the
     * corresponding {@link ManagedController}.
     *
     * @param sceneName the name of the scene, as entered in
     *                  {@link SceneManager#addScene(String, URL)}.
     * @return the loaded {@link Parent}, for method chaining.
     *
     * @throws IOException if the FXML file specified by the {@link URL} passed into
     *                     {@link SceneManager#addScene(String, URL)} cannot be opened.
     * @see SceneManager#loadParent(String, Map)
     * @see SceneManager#loadScene(String)
     * @see SceneManager#loadScene(String, Map)
     */
    public Parent loadParent(String sceneName) throws IOException {
        return loadParent(sceneName, Map.of());
    }

    /**
     * Unload a loaded scene. This releases it from active memory within the
     * {@link SceneManager#loaderMap}. The associated {@link Scene} and {@link ManagedController}
     * will stay active in memory and will not be garbage collected if they are referenced
     * somewhere outside of the {@link SceneManager}.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     */
    public void unloadScene(String sceneName) {
        FXMLLoader loader = loaderMap.get(sceneName);
        Parent parent = parentMap.remove(sceneName);
        ManagedController controller = getSceneController(sceneName);
        sceneMap.remove(sceneName);
        if (parent == null) {
            throw new RuntimeException("Cannot unload an unloaded scene!");
        }

        loaderMap.put(sceneName, new FXMLLoader(loader.getLocation()));
        controller.deinit();
    }

    /**
     * Sets the state of a loaded scene's {@link ManagedController} using its
     * {@link ManagedController#setState(Map)} method. Behavior of this method is completely
     * determined by the ManagedController's definition.
     *
     * @param sceneName       the name of the scene, as entered in
     *                        {@link SceneManager#addScene(String,
     *                        URL)}.
     * @param stateParameters a map of parameters used to set the state. Passed into
     *                        {@link ManagedController#setState(Map)}.
     */
    public void setSceneState(String sceneName, Map<String, Object> stateParameters) {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() == null) {
            throw new RuntimeException("Cannot set the state of an uninitialized scene!");
        }

        ManagedController controller = loader.getController();
        controller.setState(stateParameters);
    }

    /**
     * Resets the state of a loaded scene's {@link ManagedController} using its
     * {@link ManagedController#resetState()} method. Behavior of this method is completely
     * determined by the ManagedController's definition.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}
     */
    public void resetSceneState(String sceneName) {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() == null) {
            throw new RuntimeException("Cannot set the state of an uninitialized scene!");
        }

        ManagedController controller = loader.getController();
        controller.resetState();
    }

    /**
     * Saves the state of a loaded scene's {@link SavableController} using its
     * {@link SavableController#saveState(String)} method. Behavior of this method is completely
     * determined by the ManagedController's definition of
     * {@link SavableController#setSaveDataFromState()}.
     * <br>
     * If a scene's controller is not a SavableController, an error will be thrown.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     * @param location  the location of the save file, passed into the controller's saveState
     *                  method.
     */
    public void saveSceneState(String sceneName, String location) {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() == null) {
            throw new RuntimeException("Cannot save the state of an uninitialized scene!");
        }

        ManagedController controller = loader.getController();
        if (controller instanceof SavableController) {
            ((SavableController) controller).saveState(location);
        } else {
            throw new UnsupportedOperationException("This scene's controller doesn't support "
                                                            + "saving to a file!");
        }
    }

    /**
     * Loads the state of a loaded scene's {@link SavableController} using its
     * {@link SavableController#loadState(String)} method. Behavior of this method is completely
     * determined by the ManagedController's definition of
     * {@link SavableController#setStateFromSaveData()}.
     * <br>
     * If a scene's controller is not a SavableController, an error will be thrown.
     *
     * @param sceneName the name of the scene, as entered in {@link SceneManager#addScene(String,
     *                  URL)}.
     * @param location  the location of the save file to load from, passed into the controller's
     *                  loadState method.
     */
    public void loadSceneState(String sceneName, String location) {
        FXMLLoader loader = loaderMap.get(sceneName);
        if (loader.getRoot() == null) {
            throw new RuntimeException("Cannot load the state of an uninitialized scene!");
        }

        ManagedController controller = loader.getController();
        if (controller instanceof SavableController) {
            ((SavableController) controller).loadState(location);
        } else {
            throw new UnsupportedOperationException("This scene's controller doesn't support "
                                                            + "loading from a file!");
        }
    }

    public Map<String, FXMLLoader> getLoaderMap() {
        return loaderMap;
    }

    public Map<String, Scene> getSceneMap() {
        return sceneMap;
    }

    public Map<String, Parent> getParentMap() {
        return parentMap;
    }
}
