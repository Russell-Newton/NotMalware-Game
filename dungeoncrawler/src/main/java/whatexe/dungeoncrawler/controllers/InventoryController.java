package whatexe.dungeoncrawler.controllers;

import javafx.fxml.FXML;
import javafx.scene.Node;
import javafx.scene.control.Label;
import javafx.scene.control.ProgressBar;
import javafx.scene.image.ImageView;
import javafx.scene.input.MouseButton;
import javafx.scene.input.MouseEvent;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Line;
import javafx.scene.shape.Rectangle;
import javafx.scene.transform.Scale;
import whatexe.dungeoncrawler.ManagedController;
import whatexe.dungeoncrawler.entities.items.Consumable;
import whatexe.dungeoncrawler.entities.items.Currency;
import whatexe.dungeoncrawler.entities.items.Item;
import whatexe.dungeoncrawler.entities.player.Inventory;
import whatexe.dungeoncrawler.entities.player.Player;

import java.awt.*;

public class InventoryController extends ManagedController {

    @FXML
    private GridPane inventoryGrid;
    @FXML
    private GridPane modifiers;
    @FXML
    private Label healthLabel;
    @FXML
    private ProgressBar healthBar;
    @FXML
    private ImageView moneyIcon;
    @FXML
    private Label moneyLabel;
    @FXML
    private Pane inventoryScreen;
    @FXML
    private Pane inventoryBackground;
    @FXML
    private Label itemDescription;

    private Inventory inventory;
    private Player player;
    private Node pickedNode;
    private final int gridSize = 32;
    private final int inventoryRows = 3;
    private final int inventoryCols = 8;
    private final int modifierSize = 2;

    @FXML
    public void initialize() {
        clearInventory();
        inventoryBackground.setOnMouseMoved(event -> {
            double x = event.getX();
            double y = event.getY();
            movePickedNode(x, y);
        });
        inventoryGrid.setOnMouseMoved(event -> {
            Item item = inventory.getItemFromNode(event.getPickResult().getIntersectedNode());
            setDescriptionLabel(item);
        });


        itemDescription.setTextFill(Color.WHITE);
        inventoryBackground.setStyle("-fx-background-color: rgba(0, 0, 0, 0.5);");
        inventoryScreen.setStyle("-fx-background-color: rgba(50, 50, 50);");
    }

    private void setDescriptionLabel(Item item) {
        if (item != null) {
            itemDescription.setText(item.getDescription());
        }
    }

    @FXML
    public void inventoryClick(MouseEvent event) {
        if (event.getPickResult().getIntersectedNode() != inventoryGrid
               && !(event.getPickResult().getIntersectedNode() instanceof Line)) {
            if (event.getButton() == MouseButton.PRIMARY) {
                inventoryPickup(event);
            } else if (event.getButton() == MouseButton.SECONDARY) {
                useInventoryItem(event);
            }
        }
    }

    private void useInventoryItem(MouseEvent event) {
        Item item = inventory.getItemFromNode(event.getPickResult().getIntersectedNode());
        if (item instanceof Consumable) {
            inventory.useConsumable((Consumable) item);
            update();
        }
    }

    private void clearInventory() {
        inventoryGrid.getChildren().retainAll(inventoryGrid.getChildren().get(0));
        modifiers.getChildren().retainAll(modifiers.getChildren().get(0));
        inventoryGrid.setGridLinesVisible(true);
        modifiers.setGridLinesVisible(true);
        for (int i = 0; i < inventoryRows; i++) {
            for (int j = 0; j < inventoryCols; j++) {
                inventoryGrid.add(new Empty(), j, i);
            }
        }
        for (int i = 0; i < modifierSize; i++) {
            Empty empty = new Empty();
            empty.getTransforms().add(new Scale(2, 2, 0, 0));
            modifiers.add(empty, i, 0);
        }
    }

    private void inventoryPickup(MouseEvent event) {
        if (pickedNode == null) {
            Empty empty = new Empty();
            pickedNode = pickup(event, empty, inventoryGrid);
        } else {
            //Have picked up item and click on empty node
            if (event.getPickResult().getIntersectedNode() instanceof Empty) {
                pickup(event, pickedNode, inventoryGrid);
                pickedNode = null;
            //Have picked up item and click on another item
            } else {
                pickedNode = pickup(event, pickedNode, inventoryGrid);
            }
            update();
        }
    }

    public void setInventory(Inventory inventory) {
        this.inventory = inventory;
        this.player = inventory.getPlayer();
        healthBar.setProgress(1);
        healthLabel.setTextFill(Color.LIGHTBLUE);
        healthLabel.setText(String.format("Health: %d/%d",
                                          player.getHealth(),
                                          player.getEntityStatistics().getMaxHealth()));
        player.healthProperty().addListener((text, oldValue, newValue) -> {
            double currentHealth = (int) newValue;
            healthBar.setProgress(currentHealth / (player.getEntityStatistics().getMaxHealth()));
            healthLabel.setText(String.format("Health: %d/%d",
                                              player.getHealth(),
                                              player.getEntityStatistics().getMaxHealth()));
        });
        moneyLabel.setTextFill(Color.GOLD);
        player.moneyProperty().addListener((text, oldValue, newValue) ->
                                                   moneyLabel.setText(String.format("x %d",
                                                                          player.getMoney())));
        moneyIcon.setImage(Currency.getDefaultDisplayNode().getSpriteSheet());
        moneyIcon.setFitWidth(moneyIcon.getLayoutX());
        moneyIcon.setFitHeight(moneyIcon.getLayoutY());
    }

    @FXML
    private void modifierClick(MouseEvent event) {
        if (event.getPickResult().getIntersectedNode() != modifiers
                && !(event.getPickResult().getIntersectedNode() instanceof Line)) {
            if (pickedNode == null) {
                Empty empty = new Empty();
                empty.getTransforms().add(new Scale(2, 2, 0, 0));
                pickedNode = modifierPickup(event, empty);
                pickedNode.getTransforms().clear();
            } else {
                pickedNode.getTransforms().add(new Scale(2, 2, 0, 0));
                if (event.getPickResult().getIntersectedNode() instanceof Empty) {
                    modifierPickup(event, pickedNode);
                    pickedNode = null;
                } else {
                    pickedNode = modifierPickup(event, pickedNode);
                    pickedNode.getTransforms().clear();
                }
            }
        }
    }

    private Node modifierPickup(MouseEvent event, Node replaceNode) {
        return pickup(event, replaceNode, modifiers);
    }

    private void movePickedNode(double x, double y) {
        if (pickedNode == null) {
            return;
        }
        pickedNode.setLayoutX(0);
        pickedNode.setLayoutY(0);
        pickedNode.setTranslateX(x - (pickedNode.getLayoutBounds().getWidth() / 2));
        pickedNode.setTranslateY(y - (pickedNode.getLayoutBounds().getHeight() / 2));
    }

    private Node pickup(MouseEvent event, Node nodeGoingIn, GridPane inventoryGrid) {
        Node nodeBeingClicked = event.getPickResult().getIntersectedNode();
        int row = GridPane.getRowIndex(nodeBeingClicked);
        int col = GridPane.getColumnIndex(nodeBeingClicked);
        //Set the layout of the nodeBeingClicked to where the mouse is (stupid Javafx stuff)
        nodeBeingClicked.setLayoutX(inventoryScreen.getLayoutX() + inventoryGrid.getLayoutX()
                                    - (nodeBeingClicked.getLayoutBounds().getWidth() / 2));
        nodeBeingClicked.setLayoutY(inventoryScreen.getLayoutY() + inventoryGrid.getLayoutY()
                                    - (nodeBeingClicked.getLayoutBounds().getHeight() / 2));
        nodeBeingClicked.setTranslateX(event.getX());
        nodeBeingClicked.setTranslateY(event.getY());
        nodeBeingClicked.setMouseTransparent(true);
        inventoryGrid.getChildren().remove(nodeBeingClicked);
        inventory.removeItem(inventory.getItemFromNode(nodeBeingClicked));
        nodeGoingIn.setTranslateX(0);
        nodeGoingIn.setTranslateY(0);
        nodeGoingIn.setMouseTransparent(false);
        inventory.addItemAtCoord(inventory.getItemFromNode(nodeGoingIn), new Point(row, col));


        if (!(event.getPickResult().getIntersectedNode() instanceof Empty)) {
            inventoryBackground.getChildren().add(nodeBeingClicked);
            inventoryGrid.add(nodeGoingIn, col, row);
            return nodeBeingClicked;
        }
        return null;
    }
    
    public void update() {
        clearInventory();
        for (Point point : inventory.getInventoryItems().keySet()) {
            if (inventory.getInventoryItems().get(point) != null) {
                inventoryGrid.add(inventory.getInventoryItems().get(point).getDisplayNode(),
                                  (int) point.getY(),
                                  (int) point.getX());
            }
        }
    }

    @Override
    public void init() {

    }

    public class Empty extends Rectangle {
        public Empty() {
            super(InventoryController.this.gridSize, InventoryController.this.gridSize);
            this.setOpacity(0);
        }

        public String getDescription() {
            return "Null item";
        }

    }


}
