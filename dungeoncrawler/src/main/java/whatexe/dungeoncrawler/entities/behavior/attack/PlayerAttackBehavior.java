package whatexe.dungeoncrawler.entities.behavior.attack;

import whatexe.dungeoncrawler.entities.Player;
import whatexe.dungeoncrawler.entities.behavior.EntityBehavior;
import whatexe.dungeoncrawler.entities.motionsupport.Vector;
import whatexe.dungeoncrawler.entities.projectiles.PlayerProjectile;

public class PlayerAttackBehavior extends EntityBehavior<Player> implements AttackBehavior {

    private static final int DEFAULT_ATTACK_DELAY = 20;
    private static final int DEFAULT_ATTACK_DAMAGE = 1;

    private boolean isAttacking;
    private int attackDelay;
    private int attackDamage;
    private int ticksSinceAttack;
    private Vector attackDirection = new Vector(1, 1);

    public PlayerAttackBehavior(Player owningEntity, int attackDamage, int attackDelay) {
        super(owningEntity);

        this.attackDamage = attackDamage;
        this.attackDelay = attackDelay;
    }

    public PlayerAttackBehavior(Player owningEntity, int attackDamage) {
        this(owningEntity, attackDamage, DEFAULT_ATTACK_DELAY);
    }

    public PlayerAttackBehavior(Player owningEntity) {
        this(owningEntity, DEFAULT_ATTACK_DAMAGE, DEFAULT_ATTACK_DELAY);
    }

    @Override
    public boolean canAttack() {
        ticksSinceAttack = Math.max(0, ticksSinceAttack - 1);
        return isAttacking && ticksSinceAttack <= 0;
    }

    @Override
    public void attack() {
        Vector movementDirection =
                owningEntity.getBehaviorSet().getMovementBehavior().getMovement();
        if (!movementDirection.isZero()) {
            attackDirection = movementDirection;
        }
        PlayerProjectile bullet = new PlayerProjectile(owningEntity.getOwningRoom(),
                                                       5,
                                                       attackDirection,
                                                       attackDamage);
        bullet.getDisplayNode().setTranslateX(owningEntity.getDisplayNode().getTranslateX());
        bullet.getDisplayNode().setTranslateY(owningEntity.getDisplayNode().getTranslateY());
        owningEntity.getOwningRoom().getMiscEntities().add(bullet);

        ticksSinceAttack = attackDelay;
    }

    public boolean isAttacking() {
        return isAttacking;
    }

    public void setAttacking(boolean attacking) {
        isAttacking = attacking;
        if (!attacking) {
            ticksSinceAttack = 0;
        }
    }

    public int getAttackDamage() {
        return attackDamage;
    }

    public void setAttackDamage(int attackDamage) {
        this.attackDamage = attackDamage;
    }

    public int getAttackDelay() {
        return attackDelay;
    }

    public void setAttackDelay(int attackDelay) {
        this.attackDelay = attackDelay;
    }
}
