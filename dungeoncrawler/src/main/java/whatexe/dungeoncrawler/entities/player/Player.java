package whatexe.dungeoncrawler.entities.player;

import javafx.beans.property.SimpleIntegerProperty;
import javafx.scene.Cursor;
import javafx.scene.layout.Pane;
import whatexe.dungeoncrawler.MainApp;
import whatexe.dungeoncrawler.SceneManager;
import whatexe.dungeoncrawler.controllers.InventoryController;
import whatexe.dungeoncrawler.entities.behavior.EntityStatistics;
import whatexe.dungeoncrawler.entities.behavior.presets.PlayerBehaviorSet;
import whatexe.dungeoncrawler.entities.friends.Friend;
import whatexe.dungeoncrawler.entities.items.Item;
import whatexe.dungeoncrawler.entities.items.modifiers.DoubleShotModifier;
import whatexe.dungeoncrawler.entities.items.modifiers.ExplodeShotModifier;
import whatexe.dungeoncrawler.entities.items.modifiers.SpoonBenderModifier;
import whatexe.dungeoncrawler.layout.rooms.Room;


public class Player extends Friend {

    private static final double DAMAGE_DELAY = 50;

    private final Inventory inventory;
    private final SimpleIntegerProperty money;
    private final MalwareType malwareType;
    private boolean isInventoryOpen = false;
    private double ticksSinceDamaged;

    private double dmgTaken;
    private int ticks;
    private int enemiesKilled;


    public Player(MalwareType malwareType) {
        super(malwareType.getDefaultSprite(), null, malwareType.getDefaultStatModifiers());
        canTick = true;

        money = new SimpleIntegerProperty();
        inventory = new Inventory(this);
        this.malwareType = malwareType;

        entityStatistics.setSpeed(2);

        behaviorSet.set(malwareType.getDefaultBehaviorSet(this));
        setDisplayScale(1.25);
        addItem(new DoubleShotModifier(this));
        addItem(new ExplodeShotModifier(this));
        addItem(new SpoonBenderModifier(this));

        dmgTaken = 0;
        enemiesKilled = 0;
        ticks = 0;
    }

    public static EntityStatistics getDefaultPlayerStatistics() {
        return new EntityStatistics(50,
                                    5,
                                    50,
                                    2,
                                    1,
                                    1,
                                    1);
    }

    public boolean isInventoryFull() {
        return inventory.isInventoryFull();
    }

    public void operateInventory() {
        if (!isInventoryOpen) {
            getOwningRoom().stopTicking();
            isInventoryOpen = true;
            ((InventoryController) SceneManager
                    .getInstance().getSceneController("Inventory")).updateInventory();
            ((Pane) SceneManager.getInstance().getParent("Level"))
                    .getChildren().add(inventory.getPane());
            MainApp.getPrimaryStage().getScene().setCursor(Cursor.DEFAULT);
        } else {
            getOwningRoom().startTicking();
            isInventoryOpen = false;
            ((Pane) SceneManager.getInstance().getParent("Level"))
                    .getChildren().remove(inventory.getPane());
            MainApp.getPrimaryStage().getScene().setCursor(Cursor.NONE);
        }
    }


    @Override
    public void adjustHealth(int dHealth) {
        if (ticksSinceDamaged == 0) {
            if (dHealth < 0) {
                dmgTaken -= dHealth;
            }
            health.set(Math.min(health.getValue() + dHealth, entityStatistics.getMaxHealth()));
            ticksSinceDamaged = DAMAGE_DELAY;
        }
    }

    @Override
    public void tick() {
        super.tick();
        ticksSinceDamaged = Math.max(0, ticksSinceDamaged - 1);
        ticks++;
    }

    public void initControls() {
        ((PlayerBehaviorSet) behaviorSet.get()).initControls();
    }

    public SimpleIntegerProperty moneyProperty() {
        return money;
    }

    public int getMoney() {
        return money.get();
    }

    public void setMoney(int money) {
        this.money.set(money);
    }

    public void adjustMoney(int dMoney) {
        money.set(money.getValue() + dMoney);
    }

    public void setCurrentRoom(Room currentRoom) {
        this.owningRoom = currentRoom;
    }

    public MalwareType getMalwareType() {
        return malwareType;
    }

    public double getDmgTaken() {
        return dmgTaken;
    }

    public void addEnemiesKilled(int enemiesKilled) {
        this.enemiesKilled += enemiesKilled;
    }

    public int getEnemiesKilled() {
        return enemiesKilled;
    }

    public double getTicks() {
        return ticks;
    }

    public void recharge() {
        ((PlayerBehaviorSet) getBehaviorSet()).getSpecialAttackBehavior().recharge();
    }

    public SimpleIntegerProperty specialAttackChargeProperty() {
        return ((PlayerBehaviorSet) getBehaviorSet()).getSpecialAttackBehavior().chargeProperty();
    }

    public int getSpecialAttackMaxCharge() {
        return ((PlayerBehaviorSet) getBehaviorSet()).getSpecialAttackBehavior().getMaxCharge();
    }

    public boolean addItem(Item item) {
        return inventory.addItem(item);
    }

    public Inventory getInventory() {
        return inventory;
    }

}
